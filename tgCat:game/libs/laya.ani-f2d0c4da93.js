!function(t,bt){"use strict";class S{}S.Skeleton=null,S.AnimationTemplet=null,S.Templet=null;class b{}class C{}class F{}class i{static parse(t,e){var i,a,s,r,n,h=e.__getBuffer(),l=e.readUTFString(),o=(t._aniClassName=l,e.readUTFString().split("\n")),u=e.getUint8(),l=e.getUint32(),_=e.getUint32(),p=(0<l&&(n=h.slice(l,_)),new bt.Byte(n));for(0<_&&(t._publicExtData=h.slice(_,h.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=u,i=0;i<u;i++)for(var d=t._anis[i]=new b,c=(d.nodes=[],d.name=o[e.getUint16()]),m=(t._aniMap[c]=i,d.bone3DMap={},d.playTime=e.getFloat32(),d.nodes.length=e.getUint8()),x=d.totalKeyframeDatasLength=0;x<m;x++){var y=d.nodes[x]=new C,g=(y.childs=[],e.getInt16()),g=(0<=g&&(y.name=o[g],d.bone3DMap[y.name]=x),y.keyFrame=[],y.parentIndex=e.getInt16(),-1==y.parentIndex?y.parent=null:y.parent=d.nodes[y.parentIndex],y.lerpType=e.getUint8(),e.getUint32()),f=(p.pos=g,y.keyframeWidth=p.getUint16());if(d.totalKeyframeDatasLength+=f,0===y.lerpType||1===y.lerpType)for(y.interpolationMethod=[],y.interpolationMethod.length=f,I=0;I<f;I++)y.interpolationMethod[I]=S.AnimationTemplet.interpolation[p.getUint8()];null!=y.parent&&y.parent.childs.push(y);for(var M,g=e.getUint16(),g=(0<g&&(y.extenData=h.slice(e.pos,e.pos+g),e.pos+=g),e.getUint16()),D=0,I=0,v=y.keyFrame.length=g;I<v;I++){if((M=y.keyFrame[I]=new F).duration=e.getFloat32(),M.startTime=D,2===y.lerpType){M.interpolationData=[];var A=e.getUint8(),T=e.getFloat32();switch(T){case 254:for(M.interpolationData.length=f,r=0;r<f;r++)M.interpolationData[r]=0;break;case 255:for(M.interpolationData.length=f,r=0;r<f;r++)M.interpolationData[r]=5;break;default:for(M.interpolationData.push(T),s=1;s<A;s++)M.interpolationData.push(e.getFloat32())}}for(M.data=new Float32Array(f),M.dData=new Float32Array(f),M.nextData=new Float32Array(f),a=0;a<f;a++)M.data[a]=e.getFloat32(),-1e-8<M.data[a]&&M.data[a]<1e-8&&(M.data[a]=0);D+=M.duration}M.startTime=d.playTime,y.playTime=d.playTime,t._calculateKeyFrame(y,g,f)}}}class g{static READ_DATA(){g._DATA.offset=g._reader.getUint32(),g._DATA.size=g._reader.getUint32()}static READ_BLOCK(){for(var t=g._BLOCK.count=g._reader.getUint16(),e=g._BLOCK.blockStarts=[],i=g._BLOCK.blockLengths=[],a=0;a<t;a++)e.push(g._reader.getUint32()),i.push(g._reader.getUint32())}static READ_STRINGS(){var t=g._reader.getUint32(),e=g._reader.getUint16(),i=g._reader.pos;g._reader.pos=t+g._DATA.offset;for(var a=0;a<e;a++)g._strings[a]=g._reader.readUTFString();g._reader.pos=i}static parse(t,e){g._templet=t;(g._reader=e).__getBuffer();g.READ_DATA(),g.READ_BLOCK(),g.READ_STRINGS();for(var i=0,a=g._BLOCK.count;i<a;i++){var s=e.getUint16(),r=g._strings[s],n=g["READ_"+r];if(null==n)throw new Error("model file err,no this function:"+s+" "+r);n.call(null)}}static READ_ANIMATIONS(){var t,e=g._reader,i=e.__getBuffer(),a=e.getUint16(),s=[];for(s.length=a,t=0;t<a;t++)s[t]=S.AnimationTemplet.interpolation[e.getByte()];var r=e.getUint8();for(g._templet._anis.length=r,t=0;t<r;t++)for(var n=g._templet._anis[t]=new b,h=(n.nodes=[],n.name=g._strings[e.getUint16()]),l=(g._templet._aniMap[h]=t,n.bone3DMap={},n.playTime=e.getFloat32(),n.nodes.length=e.getInt16()),o=n.totalKeyframeDatasLength=0;o<l;o++){for(var u=n.nodes[o]=new C,_=(u.keyframeWidth=a,u.childs=[],e.getUint16()),_=(0<=_&&(u.name=g._strings[_],n.bone3DMap[u.name]=o),u.keyFrame=[],u.parentIndex=e.getInt16(),-1==u.parentIndex?u.parent=null:u.parent=n.nodes[u.parentIndex],n.totalKeyframeDatasLength+=a,u.interpolationMethod=s,null!=u.parent&&u.parent.childs.push(u),e.getUint16()),p=null,d=null,c=0,m=u.keyFrame.length=_;c<m;c++){(p=u.keyFrame[c]=new F).startTime=e.getFloat32(),d&&(d.duration=p.startTime-d.startTime),p.dData=new Float32Array(a),p.nextData=new Float32Array(a);var x=g._DATA.offset,y=e.getUint32(),x=i.slice(x+y,x+y+4*a);p.data=new Float32Array(x),d=p}p.duration=0,u.playTime=n.playTime,g._templet._calculateKeyFrame(u,_,a)}}}g._strings=[],g._BLOCK={count:0},g._DATA={offset:0,size:0};class e{constructor(){}}e.stopped=0,e.paused=1,e.playing=2;class h extends bt.EventDispatcher{constructor(){super(),this.isCache=!0,this.playbackRate=1,this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}get templet(){return this._templet}set templet(t){this.state!==e.stopped&&this.stop(!0),this._templet!==t&&(this._templet=t,this._computeFullKeyframeIndices())}get playStart(){return this._playStart}get playEnd(){return this._playEnd}get playDuration(){return this._playDuration}get overallDuration(){return this._overallDuration}get currentAnimationClipIndex(){return this._currentAnimationClipIndex}get currentKeyframeIndex(){return this._currentKeyframeIndex}get currentPlayTime(){return this._currentTime+this._playStart}get currentFrameTime(){return this._currentFrameTime}get cachePlayRate(){return this._cachePlayRate}set cachePlayRate(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&this._computeFullKeyframeIndices())}get cacheFrameRate(){return this._cacheFrameRate}set cacheFrameRate(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&this._computeFullKeyframeIndices())}set currentTime(t){if(-1!==this._currentAnimationClipIndex&&this._templet){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=bt.Stat.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentKeyframeIndex*e}}get paused(){return this._paused}set paused(t){(this._paused=t)&&this.event(bt.Event.PAUSED)}get cacheFrameRateInterval(){return this._cacheFrameRateInterval}get state(){return-1===this._currentAnimationClipIndex?e.stopped:this._paused?e.paused:e.playing}get destroyed(){return this._destroyed}_onTempletLoadedComputeFullKeyframeIndices(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()}_computeFullKeyframeIndices(){}_onAnimationTempletLoaded(){this.destroyed||this._calculatePlayDuration()}_calculatePlayDuration(){var t;this.state!==e.stopped&&(t=this._templet.getAniDuration(this._currentAnimationClipIndex),0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart)}_setPlayParams(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e}_setPlayParamsWhenStop(t,e,i=-1){this._currentTime=t,this._currentKeyframeIndex=Math.floor((0<i?i:t)/e+.01),this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1}_update(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0,t=(this._startUpdateLoopCount!==bt.Stat.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i),this.playDuration);if(i+=this._currentTime,0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=t||0===this._overallDuration&&i>=this.playEnd)return this._setPlayParamsWhenStop(t,e,this.playEnd),void this.event(bt.Event.STOPPED);if(0<t)t<=i?this._stopWhenCircleFinish?(this._setPlayParamsWhenStop(t,e),this._stopWhenCircleFinish=!1,this.event(bt.Event.STOPPED)):(this._setPlayParams(i%=t,e),this.event(bt.Event.COMPLETE)):this._setPlayParams(i,e);else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(t,e),this._stopWhenCircleFinish=!1,void this.event(bt.Event.STOPPED);this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event(bt.Event.COMPLETE)}}}_destroy(){this.offAll(),this._templet=null,this._destroyed=!0}play(t=0,e=1,i=2147483647,a=0,s=0){if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(i<0||a<0||s<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==s&&s<a)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._overallDuration=i,this._playStart=a,this._playEnd=s,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=bt.Stat.loopCount,this.event(bt.Event.PLAYED),this._calculatePlayDuration(),this._update(0)}playByFrame(t=0,e=1,i=2147483647,a=0,s=0,r=30){r=1e3/r;this.play(t,e,i,a*r,s*r)}stop(t=!0){t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event(bt.Event.STOPPED)):this._stopWhenCircleFinish=!0}destroy(){}}class _{constructor(){}static getBezierRate(t,e,i,a,s){var r=_._getBezierParamKey(e,i,a,s),n=100*r+t;if(_._bezierResultCache[n])return _._bezierResultCache[n];for(var h=_._getBezierPoints(e,i,a,s,r),l=h.length,o=0;o<l;o+=2)if(t<=h[o])return _._bezierResultCache[n]=h[o+1],h[o+1];return _._bezierResultCache[n]=1}static _getBezierParamKey(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)}static _getBezierPoints(t,e,i,a,s){if(_._bezierPointsCache[s])return _._bezierPointsCache[s];t=[0,0,t,e,i,a,1,1],e=(new bt.Bezier).getBezierPoints(t,100,3);return _._bezierPointsCache[s]=e}}_._bezierResultCache={},_._bezierPointsCache={};class f extends bt.Resource{constructor(){super(),this._anis=[],this._aniMap={},this.unfixedLastAniIndex=-1,this._fullFrames=null,this._boneCurKeyFrm=[]}static _LinearInterpolation_0(t,e,i,a,s,r,n,h,l,o=0){return i[a]=s[e]+r*n[e],1}static _QuaternionInterpolation_1(t,e,i,a,s,r,n,h,l,o=0){return bt.MathUtil.slerpQuaternionArray(s,e,l,e,0===h?0:r/h,i,a),4}static _AngleInterpolation_2(t,e,i,a,s,r,n,h,l,o=0){return 0}static _RadiansInterpolation_3(t,e,i,a,s,r,n,h,l,o=0){return 0}static _Matrix4x4Interpolation_4(t,e,i,a,s,r,n,h,l,o=0){for(var u=0;u<16;u++,e++)i[a+u]=s[e]+r*n[e];return 16}static _NoInterpolation_5(t,e,i,a,s,r,n,h,l,o=0){return i[a]=s[e],1}static _BezierInterpolation_6(t,e,i,a,s,r,n,h,l,o=null,u=0){return i[a]=s[e]+(l[e]-s[e])*_.getBezierRate(r/h,o[u],o[u+1],o[u+2],o[u+3]),5}static _BezierInterpolation_7(t,e,i,a,s,r,n,h,l,o=null,u=0){return i[a]=o[u+4]+o[u+5]*_.getBezierRate((.001*r+o[u+6])/o[u+7],o[u],o[u+1],o[u+2],o[u+3]),9}parse(t){t=new bt.Byte(t);this._aniVersion=t.readUTFString(),i.parse(this,t)}_calculateKeyFrame(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var s=0;s<e;s++)for(var r=a[s],n=0;n<i;n++)r.dData[n]=0===r.duration?0:(a[s+1].data[n]-r.data[n])/r.duration,r.nextData[n]=a[s+1].data[n];a.length--}_onAsynLoaded(t,e=0){t=new bt.Byte(t);this._aniVersion=t.readUTFString(),("LAYAANIMATION:02"===this._aniVersion?g:i).parse(this,t)}getAnimationCount(){return this._anis.length}getAnimation(t){return this._anis[t]}getAniDuration(t){return this._anis[t].playTime}getNodes(t){return this._anis[t].nodes}getNodeIndexWithName(t,e){return this._anis[t].bone3DMap[e]}getNodeCount(t){return this._anis[t].nodes.length}getTotalkeyframesLength(t){return this._anis[t].totalKeyframeDatasLength}getPublicExtData(){return this._publicExtData}getAnimationDataWithCache(t,e,i,a){e=e[i];return e&&(i=e[t])?i[a]:null}setAnimationDataWithCache(t,e,i,a,s){e=e[i]||(e[i]={});(e[t]||(e[t]=[]))[a]=s}getNodeKeyFrame(t,e,i){var a=this._boneCurKeyFrm[e],s=t.length,r=t[a=null==a||s<=a?this._boneCurKeyFrm[e]=0:a],n=i-r.startTime;if(0==n||0<n&&r.duration>n)return a;var h=0;if(0<n){for(i+=.01,h=a+1;h<s;h++)if((r=t[h]).startTime<=i&&r.startTime+r.duration>i)return this._boneCurKeyFrm[e]=h;return s-1}for(h=0;h<a;h++)if((r=t[h]).startTime<=i&&r.startTime+r.duration>i)return this._boneCurKeyFrm[e]=h;return a}getOriginalData(t,e,i,a,s){for(var r=this._anis[t].nodes,t=this._boneCurKeyFrm,n=(t.length<r.length&&(t.length=r.length),0),h=0,l=r.length,o=0;h<l;h++){var u=r[h],_=u.keyFrame,p=_[this.getNodeKeyFrame(_,h,s)],d=(u.dataOffset=o,s-p.startTime),_=u.lerpType;if(_)switch(_){case 0:case 1:for(n=0;n<u.keyframeWidth;)n+=u.interpolationMethod[n](u,n,e,o+n,p.data,d,p.dData,p.duration,p.nextData);break;case 2:for(var c=p.interpolationData,m=c.length,x=0,n=0;n<m;){var y=c[n];switch(y){case 6:case 7:n+=f.interpolation[y](u,x,e,o+x,p.data,d,p.dData,p.duration,p.nextData,c,n+1);break;default:n+=f.interpolation[y](u,x,e,o+x,p.data,d,p.dData,p.duration,p.nextData)}x++}}else for(n=0;n<u.keyframeWidth;)n+=u.interpolationMethod[n](u,n,e,o+n,p.data,d,p.dData,p.duration,p.nextData);o+=u.keyframeWidth}}getNodesCurrentFrameIndex(t,e){var i=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,s=i.length;a<s;a++){var r=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<r.keyFrame.length&&!(r.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes}getOriginalDataUnfixedRate(t,e,i){for(var a=this._anis[t].nodes,s=(t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=[],this.unfixedLastAniIndex=t),0),r=0,n=a.length,h=0;r<n;r++){var l=a[r];for(i<this.unfixedCurrentTimes[r]&&(this.unfixedCurrentFrameIndexes[r]=0),this.unfixedCurrentTimes[r]=i;this.unfixedCurrentFrameIndexes[r]<l.keyFrame.length&&!(l.keyFrame[this.unfixedCurrentFrameIndexes[r]].startTime>this.unfixedCurrentTimes[r]);)this.unfixedKeyframes[r]=l.keyFrame[this.unfixedCurrentFrameIndexes[r]],this.unfixedCurrentFrameIndexes[r]++;var o=this.unfixedKeyframes[r],u=(l.dataOffset=h,i-o.startTime);if(l.lerpType)switch(l.lerpType){case 0:case 1:for(s=0;s<l.keyframeWidth;)s+=l.interpolationMethod[s](l,s,e,h+s,o.data,u,o.dData,o.duration,o.nextData);break;case 2:for(var _=o.interpolationData,p=_.length,d=0,s=0;s<p;){var c=_[s];switch(c){case 6:case 7:s+=f.interpolation[c](l,d,e,h+d,o.data,u,o.dData,o.duration,o.nextData,_,s+1);break;default:s+=f.interpolation[c](l,d,e,h+d,o.data,u,o.dData,o.duration,o.nextData)}d++}}else for(s=0;s<l.keyframeWidth;)s+=l.interpolationMethod[s](l,s,e,h+s,o.data,u,o.dData,o.duration,o.nextData);h+=l.keyframeWidth}}}f.interpolation=[f._LinearInterpolation_0,f._QuaternionInterpolation_1,f._AngleInterpolation_2,f._RadiansInterpolation_3,f._Matrix4x4Interpolation_4,f._NoInterpolation_5,f._BezierInterpolation_6,f._BezierInterpolation_7],S.AnimationTemplet=f;class U extends bt.Graphics{drawSkin(t,e){this.drawTriangles(t.texture,0,0,t.vertices,t.uvs,t.indexes,t.transform||bt.Matrix.EMPTY,e)}static create(){return U._caches.pop()||new U}static recycle(t){t.clear(),U._caches.push(t)}}U._caches=[];class Ct{constructor(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0}initData(t){null!=t.x&&(this.x=t.x),null!=t.y&&(this.y=t.y),null!=t.skX&&(this.skX=t.skX),null!=t.skY&&(this.skY=t.skY),null!=t.scX&&(this.scX=t.scX),null!=t.scY&&(this.scY=t.scY)}getMatrix(){var t=this.mMatrix||(this.mMatrix=new bt.Matrix);return t.identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t}skew(t,e,i){var a=Math.sin(i),i=Math.cos(i),s=Math.sin(e),e=Math.cos(e);return t.setTo(t.a*e-t.b*a,t.a*s+t.b*i,t.c*e-t.d*a,t.c*s+t.d*i,t.tx*e-t.ty*a,t.tx*s+t.ty*i),t}}class Ft{constructor(){this.length=10,this.resultTransform=new Ct,this.resultMatrix=new bt.Matrix,this.inheritScale=!0,this.inheritRotation=!0,this.d=-1,this._children=[]}setTempMatrix(t){this._tempMatrix=t;for(var e=0,e=0,i=this._children.length;e<i;e++)this._children[e].setTempMatrix(this._tempMatrix)}update(t=null){this.rotation=this.transform.skX,t?(i=this.resultTransform.getMatrix(),bt.Matrix.mul(i,t,this.resultMatrix),this.resultRotation=this.rotation):(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone?this.inheritRotation&&this.inheritScale?(i=this.resultTransform.getMatrix(),bt.Matrix.mul(i,this.parentBone.resultMatrix,this.resultMatrix)):(t=this.parentBone,s=this.parentBone.resultMatrix,i=this.resultTransform.getMatrix(),a=s.a*i.tx+s.c*i.ty+s.tx,s=s.b*i.tx+s.d*i.ty+s.ty,r=new bt.Matrix,this.inheritRotation?(t=Math.atan2(t.resultMatrix.b,t.resultMatrix.a),e=Math.cos(t),t=Math.sin(t),r.setTo(e,t,-t,e,0,0),bt.Matrix.mul(this._tempMatrix,r,bt.Matrix.TEMP),bt.Matrix.TEMP.copyTo(r),i=this.resultTransform.getMatrix(),bt.Matrix.mul(i,r,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI)):(this.inheritScale,i=this.resultTransform.getMatrix(),bt.Matrix.TEMP.identity(),bt.Matrix.TEMP.d=this.d,bt.Matrix.mul(i,bt.Matrix.TEMP,this.resultMatrix)),this.resultMatrix.tx=a,this.resultMatrix.ty=s):(i=this.resultTransform.getMatrix()).copyTo(this.resultMatrix));for(var e,i,a,s,r,n=0,n=0,h=this._children.length;n<h;n++)this._children[n].update()}updateChild(){for(var t=0,t=0,e=this._children.length;t<e;t++)this._children[t].update()}setRotation(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)}updateDraw(t,e){Ft.ShowBones&&!Ft.ShowBones[this.name]||(this._sprite||(this._sprite=new bt.Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),bt.ILaya.stage.addChild(this._sprite)),this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=e+this.resultMatrix.ty);for(var i=0,i=0,a=this._children.length;i<a;i++)this._children[i].updateDraw(t,e)}addChild(t){this._children.push(t),t.parentBone=this}findBone(t){if(this.name==t)return this;for(var e,i=0,a=this._children.length;i<a;i++)if(e=this._children[i].findBone(t))return e;return null}localToWorld(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty}}Ft.ShowBones={};class M{constructor(){}static getRelativeUV(t,e,i=null){for(var a,s=t[0],r=t[2]-t[0],n=t[1],t=t[5]-t[1],h=((i=i||[]).length=e.length,a=i.length,1/r),l=1/t,o=0;o<a;o+=2)i[o]=(e[o]-s)*h,i[o+1]=(e[o+1]-n)*l;return i}static getAbsoluteUV(t,e,i=null){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return i?(bt.Utils.copyArray(i,e),i):e;var a,s,r=t[0],n=t[2]-t[0],h=t[1],l=t[5]-t[1];for((i=i||[]).length=e.length,s=i.length,a=0;a<s;a+=2)i[a]=e[a]*n+r,i[a+1]=e[a+1]*l+h;return i}}class a{constructor(){this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertices=new Float32Array([0,0,100,0,100,100,0,100]),this.indexes=new Uint16Array([0,1,3,3,1,2]),this.useUvTransform=!1,this.canvasPadding=1}getBounds(){return bt.Rectangle._getWrapRec(this.vertices)}}class s extends a{constructor(){super()}init2(t,e,i,a){this.transform&&(this.transform=null);e=e||[0,1,3,3,1,2];this.texture=t,this.indexes=new Uint16Array(e),this.vertices=new Float32Array(i),this.uvs=new Float32Array(a)}}class wt{constructor(){this.srcDisplayIndex=-1,this.type="src",this.displayIndex=-1,this.originalIndex=-1,this._replaceDic={}}showSlotData(t,e=!0){this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null}showDisplayByName(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))}replaceDisplayByName(t,e){this.currSlotData&&(t=this.currSlotData.getDisplayByName(t),e=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(t,e))}replaceDisplayByIndex(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.originalIndex==t&&this.showDisplayByIndex(t))}showDisplayByIndex(t){this.originalIndex=t,null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&-1<t&&t<this.currSlotData.displayArr.length?(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData&&(t=this.currDisplayData.name,this.currTexture=this.templet.getTexture(t),this.currTexture&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture)))):(this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null)}replaceSkin(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)}setParentMatrix(t){this._parentMatrix=t}static createSkinMesh(){return new s}static isSameArr(t,e){if(t.length!=e.length)return!1;for(var i=t.length,a=0;a<i;a++)if(t[a]!=e[a])return!1;return!0}getSaveVerticle(t){return wt.useSameMatrixAndVerticle&&this._preGraphicVerticle&&wt.isSameArr(t,this._preGraphicVerticle)?t=this._preGraphicVerticle:(t=bt.ILaya.Utils.copyArray([],t),this._preGraphicVerticle=t),t}static isSameMatrix(t,e){return t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&Math.abs(t.tx-e.tx)<1e-5&&Math.abs(t.ty-e.ty)<1e-5}getSaveMatrix(t){var e;return wt.useSameMatrixAndVerticle&&this._preGraphicMatrix&&wt.isSameMatrix(t,this._preGraphicMatrix)?t=this._preGraphicMatrix:(e=t.clone(),this._preGraphicMatrix=t=e),t}draw(t,e,i=!1,a=1){if((null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var s,r,n,h,l=this.currTexture;switch(this._diyTexture&&(l=this._diyTexture),this.currDisplayData.type){case 0:t&&(h=this.getDisplayMatrix(),this._parentMatrix&&(r=!1,h&&(bt.Matrix.mul(h,this._parentMatrix,bt.Matrix.TEMP),h=i?(null==this._resultMatrix&&(this._resultMatrix=new bt.Matrix),this._resultMatrix):wt._tempResultMatrix,this._diyTexture&&this.currDisplayData.uvs?((n=wt._tempMatrix).identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(n.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(r=!0,n.rotate(-Math.PI/2)),bt.Matrix.mul(n,bt.Matrix.TEMP,h)):bt.Matrix.TEMP.copyTo(h),(h=i?h:this.getSaveMatrix(h))._checkTransform(),r?t.drawTexture(l,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,h,a):t.drawTexture(l,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,h,a))));break;case 1:if(null==(s=i?(null==this._skinSprite&&(this._skinSprite=wt.createSkinMesh()),this._skinSprite):wt.createSkinMesh()))return;null==this.currDisplayData.bones?(n=this.currDisplayData.weights,this.deformData&&(n=this.deformData),r=this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=M.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=M.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),this._curDiyUV):this.currDisplayData.uvs,this._mVerticleArr=n,this.currDisplayData.triangles.length,h=this.currDisplayData.triangles,this.deformData&&!i&&(this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr)),s.init2(l,h,this._mVerticleArr,r),n=this.getDisplayMatrix(),this._parentMatrix&&n&&(bt.Matrix.mul(n,this._parentMatrix,bt.Matrix.TEMP),h=i?(null==this._resultMatrix&&(this._resultMatrix=new bt.Matrix),this._resultMatrix):wt._tempResultMatrix,bt.Matrix.TEMP.copyTo(h),i||(h=this.getSaveMatrix(h)),s.transform=h)):this.skinMesh(e,s),t.drawSkin(s,a);break;case 2:if(null==(s=i?(null==this._skinSprite&&(this._skinSprite=wt.createSkinMesh()),this._skinSprite):wt.createSkinMesh()))return;this.skinMesh(e,s),t.drawSkin(s,a)}}}skinMesh(t,e){var i,a,s,r,n=this.currTexture,h=this.currDisplayData.bones,l=this._diyTexture?(n=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=M.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=M.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),this._curDiyUV):this.currDisplayData.uvs,o=this.currDisplayData.weights,u=this.currDisplayData.triangles,_=0,p=0,d=0,c=0,m=0,x=0,y=0;if(wt._tempVerticleArr.length=0,r=wt._tempVerticleArr,this.deformData&&0<this.deformData.length)for(var g=0,x=0,y=h.length;x<y;){for(d=h[x++]+x,p=_=0;x<d;x++)i=t[h[x]],a=o[c]+this.deformData[g++],s=o[c+1]+this.deformData[g++],m=o[c+2],_+=(a*i.a+s*i.c+i.tx)*m,p+=(a*i.b+s*i.d+i.ty)*m,c+=3;r.push(_,p)}else for(x=0,y=h.length;x<y;){for(d=h[x++]+x,p=_=0;x<d;x++)i=t[h[x]],a=o[c],s=o[c+1],m=o[c+2],_+=(a*i.a+s*i.c+i.tx)*m,p+=(a*i.b+s*i.d+i.ty)*m,c+=3;r.push(_,p)}this._mVerticleArr=r,u=u,this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr),e.init2(n,u,this._mVerticleArr,l)}drawBonePoint(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")}getDisplayMatrix(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null}getMatrix(){return this._resultMatrix}copy(){var t=new wt;return t.type="copy",t.name=this.name,t.attachmentName=this.attachmentName,t.srcDisplayIndex=this.srcDisplayIndex,t.parent=this.parent,t.displayIndex=this.displayIndex,t.templet=this.templet,t.currSlotData=this.currSlotData,t.currTexture=this.currTexture,t.currDisplayData=this.currDisplayData,t}}wt._tempMatrix=new bt.Matrix,wt._tempResultMatrix=new bt.Matrix,wt.useSameMatrixAndVerticle=!0,wt._tempVerticleArr=[];class kt{constructor(){this.deformSlotDataList=[]}}class Pt{constructor(){this.deformSlotDisplayList=[]}}class Lt{constructor(){this.slotIndex=-1,this.timeList=[],this.vectices=[],this.tweenKeyList=[],this.frameIndex=0}binarySearch1(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var s=a>>>1;;){if(t[Math.floor(s+1)]<=e?i=s+1:a=s,i==a)return i+1;s=i+a>>>1}return 0}apply(t,e,i=1){if(t+=.05,!(this.timeList.length<=0)){var a=0,s=this.timeList[0];if(!(t<s)){var r=this.vectices[0].length,n=[],s=this.binarySearch1(this.timeList,t);if(this.frameIndex=s,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<r;a++)n[a]+=(h[a]-n[a])*i;else for(a=0;a<r;a++)n[a]=h[a];this.deformData=n}else{var l,o=this.vectices[this.frameIndex-1],u=this.vectices[this.frameIndex],_=this.timeList[this.frameIndex-1],p=this.timeList[this.frameIndex];for(i=this.tweenKeyList[s-1]?(t-_)/(p-_):0,a=0;a<r;a++)l=o[a],n[a]=l+(u[a]-l)*i;this.deformData=n}}}}}class Ut{constructor(){this.drawOrder=[]}}class Bt{constructor(){}}class k{constructor(t,e){this.isSpine=!0,this.isDebug=!1,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]);for(var i=this._bones.length=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}apply(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}}_applyIk1(t,e,i,a){var s=t.parentBone,r=1/(s.resultMatrix.a*s.resultMatrix.d-s.resultMatrix.b*s.resultMatrix.c),e=e-s.resultMatrix.tx,i=i-s.resultMatrix.ty,n=(e*s.resultMatrix.d-i*s.resultMatrix.c)*r-t.transform.x,i=(i*s.resultMatrix.a-e*s.resultMatrix.b)*r-t.transform.y,e=Math.atan2(i,n)*k.radDeg-t.transform.skX;t.transform.scX<0&&(e+=180),180<e?e-=360:e<-180&&(e+=360),t.transform.skX=t.transform.skY=t.transform.skX+e*a,t.update()}updatePos(t,e){this._sp&&this._sp.pos(t,e)}_applyIk2(t,e,i,a,s,r){var n,h,l,o,u,_,p,d,c,m,x,y,g,f,M,D,I,v,A,T,S,b,C,F,w;0!=r&&(n=t.resultTransform.x,h=t.resultTransform.y,o=(T=t.transform.scX)<0?(T=-T,l=180,-1):(l=0,1),(v=t.transform.scY)<0&&(v=-v,o=-o),u=(C=e.transform.scX)<0?(C=-C,180):0,_=e.resultTransform.x,F=t.resultMatrix.a,m=t.resultMatrix.c,A=t.resultMatrix.b,g=t.resultMatrix.d,b=(x=Math.abs(T-v)<=1e-4)?(y=F*_+m*(p=e.resultTransform.y)+t.resultMatrix.tx,A*_+g*p+t.resultMatrix.ty):(p=0,y=F*_+t.resultMatrix.tx,A*_+t.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new bt.Sprite,bt.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(i,a,15,"#ffff00"),this._sp.graphics.drawCircle(y,b,15,"#ff00ff")),t.setRotation(Math.atan2(b-t.resultMatrix.ty,y-t.resultMatrix.tx)),F=(d=t.parentBone).resultMatrix.a,m=d.resultMatrix.c,A=d.resultMatrix.b,D=1/(F*(g=d.resultMatrix.d)-m*A),f=((i=i-d.resultMatrix.tx)*g-(a=a-d.resultMatrix.ty)*m)*D-n,I=(a*F-i*A)*D-h,y=((i=y-d.resultMatrix.tx)*g-(a=b-d.resultMatrix.ty)*m)*D-n,b=(a*F-i*A)*D-h,d=Math.sqrt(y*y+b*b),D=e.length*C,x?((y=(f*f+I*I-d*d-(D*=T)*D)/(2*d*D))<-1?y=-1:1<y&&(y=1),c=Math.acos(y)*s,F=d+D*y,m=D*Math.sin(c),w=Math.atan2(I*F-f*m,f*F+I*m)):(b=(F=T*D)*F,C=(m=v*D)*m,x=f*f+I*I,y=Math.atan2(I,f),0<(g=(D=-2*C*d)*D-4*(I=C-b)*(A=C*d*d+b*x-b*C))&&(f=Math.sqrt(g),D=(f=-(D+(f=D<0?-f:f))/2)/I,I=A/f,(A=Math.abs(D)<Math.abs(I)?D:I)*A<=x&&(a=Math.sqrt(x-A*A)*s,w=y-Math.atan2(a,A),c=Math.atan2(a/v,(A-d)/T))),S=T=A=v=I=D=f=0,A<(g=(i=d+F)*i)&&(v=0,A=g,T=i),(g=(i=d-F)*i)<(M=Number.MAX_VALUE)&&(f=Math.PI,M=g,D=i),b=Math.acos(-F*d/(b-C)),(g=(i=F*Math.cos(b)+d)*i+(a=m*Math.sin(b))*a)<M&&(f=b,M=g,D=i,I=a),A<g&&(v=b,A=g,T=i,S=a),c=x<=(M+A)/2?(w=y-Math.atan2(I*s,D),f*s):(w=y-Math.atan2(S*s,T),v*s)),C=Math.atan2(p,_)*o,F=t.resultTransform.skX,180<(w=(w-C)*k.radDeg+l-F)?w-=360:w<-180&&(w+=360),t.resultTransform.x=n,t.resultTransform.y=h,t.resultTransform.skX=t.resultTransform.skY=F+w*r,F=e.resultTransform.skX,F%=360,180<(c=(c+C)*k.radDeg*o+u-F)?c-=360:c<-180&&(c+=360),e.resultTransform.x=_,e.resultTransform.y=p,e.resultTransform.skX=e.resultTransform.skY=e.resultTransform.skY+c*r,t.update())}_applyIk3(t,e,i,a,s,r){var n,h,l,o,u,_,p,d,c,m,x;0!=r&&(r=(r=e.resultMatrix.a*e.length)*r+(r=e.resultMatrix.b*e.length)*r,d=Math.sqrt(r),n=t.resultMatrix.tx,h=t.resultMatrix.ty,p=(c=(u=e.resultMatrix.tx)-n)*c+(m=(_=e.resultMatrix.ty)-h)*m,x=Math.sqrt(p),l=(c=i-t.resultMatrix.tx)*c+(m=a-t.resultMatrix.ty)*m,_=d+x<=(o=Math.sqrt(l))||o+d<=x||o+x<=d?(u=n+(d=d+x<=o?1:-1)*(i-n)*x/o,h+d*(a-h)*x/o):(x=n+c*(d=(p-r+l)/(2*l)),r=h+m*d,p=-m*(m=Math.sqrt(p-d*d*l)/o),d=c*m,0<s?(u=x-p,r-d):(u=x+p,r+d)),l=u,o=_,this.isDebug&&(this._sp||(this._sp=new bt.Sprite,bt.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(n,h,15,"#ff00ff"),this._sp.graphics.drawCircle(i,a,15,"#ffff00"),this._sp.graphics.drawCircle(l,o,15,"#ff00ff")),c=Math.atan2(o-t.resultMatrix.ty,l-t.resultMatrix.tx),t.setRotation(c),(m=k._tempMatrix).identity(),m.rotate(c),m.scale(t.resultMatrix.getScaleX(),t.resultMatrix.getScaleY()),m.translate(t.resultMatrix.tx,t.resultMatrix.ty),m.copyTo(t.resultMatrix),t.updateChild(),s=Math.atan2(a-o,i-l),e.setRotation(s),(x=k._tempMatrix).identity(),x.rotate(s),x.scale(e.resultMatrix.getScaleX(),e.resultMatrix.getScaleY()),x.translate(l,o),m.copyTo(e.resultMatrix),e.updateChild())}}k.radDeg=180/Math.PI,k.degRad=Math.PI/180,k._tempMatrix=new bt.Matrix;class Et{constructor(){this.boneNames=[],this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneIndexs=[]}}class P{constructor(t,e){this._debugKey=!1,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,a=0,s=i.length;a<s;a++)this.bones.push(e[i[a]])}apply(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,s=0<a,r=this.data.spacingMode,n="length"==r,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],_=this.bones.length,p=l?_:_+1,d=[],c=((this._spaces=d)[0]=this.position,this.spacing);if(o||n)for(var m=0,x=p-1;m<x;){var y=this.bones[m],g=(M=y.length)*y.resultMatrix.a,f=M*y.resultMatrix.b,M=Math.sqrt(g*g+f*f);o&&(u[m]=M),d[++m]=n?Math.max(0,M+c):c}else for(m=1;m<p;m++)d[m]=c;var D=this.computeWorldPositions(this.target,t,e,p,l,"percent"==this.data.positionMode,"percent"==r);if(this._debugKey){for(m=0;m<D.length;m++)e.drawCircle(D[m++],D[m++],5,"#00ff00");for(var I=[],m=0;m<D.length;m++)I.push(D[m++],D[m++]);e.drawLines(0,0,I,"#ff0000")}var v,A=D[0],T=D[1],S=this.data.offsetRotation,E="chain"==h&&0==S;for(m=0,v=3;m<_;m++,v+=3){(y=this.bones[m]).resultMatrix.tx+=(A-y.resultMatrix.tx)*i,y.resultMatrix.ty+=(T-y.resultMatrix.ty)*i;var b,C,F,w,k,P,L,U=(g=D[v])-A,B=(f=D[v+1])-T;o&&0!=(M=u[m])&&(b=(Math.sqrt(U*U+B*B)/M-1)*a+1,y.resultMatrix.a*=b,y.resultMatrix.c*=b),A=g,T=f,s&&(b=y.resultMatrix.a,C=y.resultMatrix.c,F=y.resultMatrix.b,w=y.resultMatrix.d,L=l?D[v-1]:0==d[m+1]?D[v+2]:Math.atan2(B,U),L-=Math.atan2(F,b)-S/180*Math.PI,E&&(k=Math.cos(L),P=Math.sin(L),A+=((M=y.length)*(k*b-P*F)-U)*a,T+=(M*(P*b+k*F)-B)*a),L>Math.PI?L-=2*Math.PI:L<-Math.PI&&(L+=2*Math.PI),L*=a,k=Math.cos(L),P=Math.sin(L),y.resultMatrix.a=k*b-P*F,y.resultMatrix.c=k*C-P*w,y.resultMatrix.b=P*b+k*F,y.resultMatrix.d=P*C+k*w)}}}computeWorldVertices2(t,e,i,a,s,r){var n,h,l=t.currDisplayData.bones,o=t.currDisplayData.weights,u=t.currDisplayData.triangles,_=0,p=0,d=0,c=0,m=0,x=0,y=0,g=0,f=0,M=0;if(null==l){var D,u=u||o;if(t.deformData&&(u=t.deformData),D=t.parent,e)for(h=e.length,_=0;_<h;_++)if(e[_].name==D){n=e[_];break}var I,v=(I=(I=n?n.resultMatrix:I)||P._tempMt).tx,A=I.ty,T=I.a,S=I.b,b=I.c,C=I.d;for(n&&(C*=n.d),p=i,m=r;m<a;p+=2,m+=2)f=u[p],M=u[p+1],s[m]=f*T+M*S+v,s[m+1]=-(f*b+M*C+A)}else{for(_=0;_<i;_+=2)p+=(c=l[p])+1,d+=c;for(var F=e,m=r,x=3*d;m<a;m+=2){for(g=y=0,c=l[p++],c+=p;p<c;p++,x+=3){var w=F[l[p]].resultMatrix,f=o[x],M=o[x+1],k=o[x+2];y+=(f*w.a+M*w.c+w.tx)*k,g+=(f*w.b+M*w.d+w.ty)*k}s[m]=y,s[m+1]=g}}}computeWorldPositions(t,E,R,e,N,O,V){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var i,a,s,r,Y,n,h,l=[],o=0,u=t.currDisplayData.verLen,K=this.position,X=this._spaces,_=[],p=u/6,W=-1;if(p--,this.computeWorldVertices2(t,E,2,u-=4,l,0),this._debugKey)for(o=0;o<l.length;)R.drawCircle(l[o++],l[o++],10,"#ff0000");i=l,this._curves.length=p;for(var d=this._curves,c=0,m=i[0],x=i[1],y=0,g=0,f=0,M=0,D=0,I=0,o=0,v=2;o<p;o++,v+=6)P=2*(b=.1875*(m-2*(y=i[v])+(f=i[v+2])))+(F=.09375*(3*(y-f)-m+(D=i[v+4]))),L=2*(C=.1875*(x-2*(g=i[v+1])+(M=i[v+3])))+(w=.09375*(3*(g-M)-x+(I=i[v+5]))),U=.75*(y-m)+b+.16666667*F,B=.75*(g-x)+C+.16666667*w,c+=Math.sqrt(U*U+B*B),U+=P,B+=L,P+=F,L+=w,c+=Math.sqrt(U*U+B*B),U+=P,B+=L,c+=Math.sqrt(U*U+B*B),U+=P+F,B+=L+w,c+=Math.sqrt(U*U+B*B),d[o]=c,m=D,x=I;if(O&&(K*=c),V)for(o=0;o<e;o++)X[o]*=c;for(var A=this._segments,T=0,S=s=a=o=0;o<e;o++,a+=3)if((r=K+=Y=X[o])<0)this.addBeforePosition(r,i,0,_,a);else if(c<r)this.addAfterPosition(r-c,i,u-4,_,a);else{for(;;s++)if(!((h=d[s])<r)){0==s?r/=h:r=(r-(n=d[s-1]))/(h-n);break}if(s!=W){var b,C,F,w,W=s,k=6*s,m=i[k],x=i[k+1],y=i[k+2],g=i[k+3],f=i[k+4],M=i[k+5],P=2*(b=.03*(m-2*y+f))+(F=.006*(3*(y-f)-m+(D=i[k+6]))),L=2*(C=.03*(x-2*g+M))+(w=.006*(3*(g-M)-x+(I=i[k+7]))),U=.3*(y-m)+b+.16666667*F,B=.3*(g-x)+C+.16666667*w,T=Math.sqrt(U*U+B*B);for(A[0]=T,k=1;k<8;k++)U+=P,B+=L,P+=F,L+=w,T+=Math.sqrt(U*U+B*B),A[k]=T;U+=P,B+=L,T+=Math.sqrt(U*U+B*B),A[8]=T,U+=P+F,B+=L+w,T+=Math.sqrt(U*U+B*B),A[9]=T,S=0}for(r*=T;;S++)if(!((h=A[S])<r)){0==S?r/=h:r=S+(r-(n=A[S-1]))/(h-n);break}this.addCurvePosition(.1*r,m,x,y,g,f,M,D,I,_,a,N||0<o&&0==Y)}return _}addBeforePosition(t,e,i,a,s){var r=e[i],n=e[i+1],h=e[i+2]-r,e=e[i+3]-n,i=Math.atan2(e,h);a[s]=r+t*Math.cos(i),a[s+1]=n+t*Math.sin(i),a[s+2]=i}addAfterPosition(t,e,i,a,s){var r=e[i+2],n=e[i+3],h=r-e[i],e=n-e[i+1],i=Math.atan2(e,h);a[s]=r+t*Math.cos(i),a[s+1]=n+t*Math.sin(i),a[s+2]=i}addCurvePosition(t,e,i,a,s,r,n,h,l,o,u,_){var p=(t=0==t?1e-4:t)*t,d=p*t,c=1-t,m=c*c,x=m*c,y=c*t,g=3*y,c=c*g,g=g*t,t=e*x+a*c+r*g+h*d,h=i*x+s*c+n*g+l*d;o[u]=t,o[u+1]=h,o[u+2]=_?Math.atan2(h-(i*m+s*y*2+n*p),t-(e*m+a*y*2+r*p)):0}}P.BEFORE=-2,P.AFTER=-3,P._tempMt=new bt.Matrix;class Rt{constructor(){this.bones=[]}}class l{constructor(t,e){var i,a;for(this._temp=[],this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex],i=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}apply(){for(var t=this.target.resultMatrix.a,e=this.target.resultMatrix.b,i=this.target.resultMatrix.c,a=this.target.resultMatrix.d,s=0,r=this._bones.length;s<r;s++){var n,h,l,o,u,_,p,d,c=this._bones[s];0<this.rotateMix&&(h=c.resultMatrix.a,u=c.resultMatrix.b,l=c.resultMatrix.c,_=c.resultMatrix.d,(d=Math.atan2(i,t)-Math.atan2(l,h)+this._data.offsetRotation*Math.PI/180)>Math.PI?d-=2*Math.PI:d<-Math.PI&&(d+=2*Math.PI),d*=this.rotateMix,n=Math.cos(d),p=Math.sin(d),c.resultMatrix.a=n*h-p*l,c.resultMatrix.b=n*u-p*_,c.resultMatrix.c=p*h+n*l,c.resultMatrix.d=p*u+n*_),this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),c.resultMatrix.tx+=(this._temp[0]-c.resultMatrix.tx)*this.translateMix,c.resultMatrix.ty+=(this._temp[1]-c.resultMatrix.ty)*this.translateMix,c.updateChild()),0<this.scaleMix&&(h=Math.sqrt(c.resultMatrix.a*c.resultMatrix.a+c.resultMatrix.c*c.resultMatrix.c),l=Math.sqrt(t*t+i*i),o=1e-5<h?(h+(l-h+this._data.offsetScaleX)*this.scaleMix)/h:0,c.resultMatrix.a*=o,c.resultMatrix.c*=o,h=Math.sqrt(c.resultMatrix.b*c.resultMatrix.b+c.resultMatrix.d*c.resultMatrix.d),l=Math.sqrt(e*e+a*a),o=1e-5<h?(h+(l-h+this._data.offsetScaleY)*this.scaleMix)/h:0,c.resultMatrix.b*=o,c.resultMatrix.d*=o),0<this.shearMix&&(u=c.resultMatrix.b,_=c.resultMatrix.d,p=Math.atan2(_,u),(d=Math.atan2(a,e)-Math.atan2(i,t)-(p-Math.atan2(c.resultMatrix.c,c.resultMatrix.a)))>Math.PI?d-=2*Math.PI:d<-Math.PI&&(d+=2*Math.PI),d=p+(d+this._data.offsetShearY*Math.PI/180)*this.shearMix,o=Math.sqrt(u*u+_*_),c.resultMatrix.b=Math.cos(d)*o,c.resultMatrix.d=Math.sin(d)*o)}}}class r extends bt.Sprite{constructor(t=null,e=0){super(),this._boneMatrixArray=[],this._lastTime=0,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._index=-1,this._total=-1,this._indexControl=!1,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,this._playAudio=!0,this._soundChannelArr=[],t&&this.init(t,e)}init(t,e=0){var i,a,s,r,n=0;if(1==e)for(this._graphicsCache=[],n=0,i=t.getAnimationCount();n<i;n++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=e,this._templet=t,this._templet._addReference(1),this._player=new h,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,0<t.ikArr.length)for(this._ikArr=[],n=0,i=t.ikArr.length;n<i;n++)this._ikArr.push(new k(t.ikArr[n],this._boneList));if(0<t.pathArr.length)for(null==this._pathDic&&(this._pathDic={}),n=0,i=t.pathArr.length;n<i;n++)a=t.pathArr[n],s=new P(a,this._boneList),(r=this._boneSlotDic[a.name])&&((s=new P(a,this._boneList)).target=r),this._pathDic[a.name]=s;if(0<t.tfArr.length)for(this._tfArr=[],n=0,i=t.tfArr.length;n<i;n++)this._tfArr.push(new l(t.tfArr[n],this._boneList));0<t.skinDataArray.length&&(e=this._templet.skinDataArray[this._skinIndex],this._skinName=e.name),this._player.on(bt.Event.PLAYED,this,this._onPlay),this._player.on(bt.Event.STOPPED,this,this._onStop),this._player.on(bt.Event.PAUSED,this,this._onPause)}get url(){return this._aniPath}set url(t){this.load(t)}load(t,e=null,i=0){this._aniPath=t,this._complete=e,this._loadAniMode=i,bt.ILaya.loader.load([{url:t,type:bt.ILaya.Loader.BUFFER}],bt.Handler.create(this,this._onLoaded))}_onLoaded(){var t,e=bt.ILaya.Loader.getRes(this._aniPath);null!=e&&(null==S.Templet.TEMPLET_DICTIONARY&&(S.Templet.TEMPLET_DICTIONARY={}),(t=S.Templet.TEMPLET_DICTIONARY[this._aniPath])?t.isParseFail?this._parseFail():t.isParserComplete?this._parseComplete():(t.on(bt.Event.COMPLETE,this,this._parseComplete),t.on(bt.Event.ERROR,this,this._parseFail)):((t=new S.Templet)._setCreateURL(this._aniPath),(S.Templet.TEMPLET_DICTIONARY[this._aniPath]=t).on(bt.Event.COMPLETE,this,this._parseComplete),t.on(bt.Event.ERROR,this,this._parseFail),t.isParserComplete=!1,t.parseData(null,e)))}_parseComplete(){var t=S.Templet.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)}_parseFail(){console.log("[Error]:"+this._aniPath+"解析失败")}_onPlay(){this.event(bt.Event.PLAYED)}_onStop(){var t,e=this._templet.eventAniArr[this._aniClipIndex];if(e&&this._eventIndex<e.length)for(;this._eventIndex<e.length;this._eventIndex++)(t=e[this._eventIndex]).time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event(bt.Event.LABEL,t);this._drawOrder=null,this.event(bt.Event.STOPPED)}_onPause(){this.event(bt.Event.PAUSED)}_parseSrcBoneMatrix(){var t=0,e=0;for(e=this._templet.srcBoneMatrixArr.length,t=0;t<e;t++)this._boneMatrixArray.push(new bt.Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);for(var i,a,s=this._templet.boneSlotArray,t=0,e=s.length;t<e;t++)i=s[t],null==(a=this._bindBoneBoneSlotDic[i.parent])&&(this._bindBoneBoneSlotDic[i.parent]=a=[]),this._boneSlotDic[i.name]=i=i.copy(),a.push(i),this._boneSlotArray.push(i)}}_emitMissedEvents(t,e,i=0){var a=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(a)for(var s,r=0,n=a.length,r=i;r<n;r++)(s=a[r]).time>=this._player.playStart&&s.time<=this._player.playEnd&&this.event(bt.Event.LABEL,s)}_update(t=!0){var e,i,a,s,r;t&&this._pause||t&&this._indexControl||(s=this.timer.currTimer,e=this._player.currentKeyframeIndex,i=s-this._lastTime,t?this._player._update(i):e=-1,this._lastTime=s,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,this._index<0||0<i&&this._clipIndex==e&&this._lastUpdateAniClipIndex==this._aniClipIndex||(this._lastUpdateAniClipIndex=this._aniClipIndex,e>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0),(t=this._templet.eventAniArr[this._aniClipIndex])&&this._eventIndex<t.length&&((s=t[this._eventIndex]).time>=this._player.playStart&&s.time<=this._player.playEnd?this._player.currentPlayTime>=s.time&&(this.event(bt.Event.LABEL,s),this._eventIndex++,this._playAudio&&s.audioValue&&"null"!==s.audioValue&&"undefined"!==s.audioValue&&(a=bt.SoundManager.playSound(this._player.templet._path+s.audioValue,1,bt.Handler.create(this,this._onAniSoundStoped)),bt.SoundManager.playbackRate=this._player.playbackRate,a&&this._soundChannelArr.push(a))):s.time<this._player.playStart&&this._playAudio&&s.audioValue&&"null"!==s.audioValue&&"undefined"!==s.audioValue?(this._eventIndex++,a=bt.SoundManager.playSound(this._player.templet._path+s.audioValue,1,bt.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-s.time)/1e3),bt.SoundManager.playbackRate=this._player.playbackRate,a&&this._soundChannelArr.push(a)):this._eventIndex++),0==this._aniMode?(r=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=r&&(this.graphics=r):1==this._aniMode?(r=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics())&&this.graphics!=r&&(this.graphics=r):this._createGraphics())))}_onAniSoundStoped(t){for(var e,i=this._soundChannelArr.length,a=0;a<i;a++)((e=this._soundChannelArr[a]).isStopped||t)&&(e.isStopped||e.stop(),this._soundChannelArr.splice(a,1),i--,a--)}_createGraphics(t=-1){var e,i=(t=-1==t?this._clipIndex:t)*this._player.cacheFrameRateInterval,a=this._templet.drawOrderAniArr[this._aniClipIndex];if(a&&0<a.length)for(this._drawOrderIndex=0,e=a[this._drawOrderIndex];i>=e.time&&(this._drawOrder=e.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=a.length));)e=a[this._drawOrderIndex];0!=this._aniMode&&1!=this._aniMode&&this.graphics instanceof U?this.graphics.clear():this.graphics=U.create();var s,r,n=this.graphics,h=this._templet.getNodes(this._aniClipIndex),l=0==this._player.state,l=(this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,t,l?i+this._player.cacheFrameRateInterval:i),this._aniSectionDic[this._aniClipIndex]),o=0,u=0,_=0,p=0,d=0,c=this._templet.srcBoneMatrixArr.length,m=this._curOriginalData;for(d=l[u=0];u<c;u++){var x,y=(x=this._boneList[u]).resultTransform,g=this._templet.srcBoneMatrixArr[u];y.scX=g.scX*m[o++],y.skX=g.skX+m[o++],y.skY=g.skY+m[o++],y.scY=g.scY*m[o++],y.x=g.x+m[o++],y.y=g.y+m[o++],8===this._templet.tMatrixDataLen&&(y.skewX=g.skewX+m[o++],y.skewY=g.skewY+m[o++])}var f={},M={};for(d+=l[1];u<d;u++)f[(v=h[u]).name]=m[o++],M[v.name]=m[o++],o+=4;var D={},I={};for(d+=l[2];u<d;u++)D[(v=h[u]).name]=m[o++],I[v.name]=m[o++],o+=4;if(this._pathDic)for(d+=l[3];u<d;u++){var v=h[u],A=this._pathDic[v.name];if(A)switch(new bt.Byte(v.extenData).getByte()){case 1:A.position=m[o++];break;case 2:A.spacing=m[o++];break;case 3:A.rotateMix=m[o++],A.translateMix=m[o++]}}if(this._rootBone.update(this._yReverseMatrix||bt.Matrix.TEMP.identity()),this._ikArr)for(var T,u=0,d=this._ikArr.length;u<d;u++)(T=this._ikArr[u]).name in D&&(T.bendDirection=D[T.name]),T.name in I&&(T.mix=I[T.name]),T.apply();if(this._pathDic)for(var S in this._pathDic)(A=this._pathDic[S]).apply(this._boneList,n);if(this._tfArr)for(u=0,p=this._tfArr.length;u<p;u++)this._tfArr[u].apply();for(u=0,p=this._boneList.length;u<p;u++)if(x=this._boneList[u],r=this._bindBoneBoneSlotDic[x.name],x.resultMatrix.copyTo(this._boneMatrixArray[u]),r)for(_=0,d=r.length;_<d;_++)(s=r[_])&&s.setParentMatrix(x.resultMatrix);var b,C,F,w={},l=this._templet.deformAniArr;if(l&&0<l.length){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,u=0,d=this._boneSlotArray.length;u<d;u++)(s=this._boneSlotArray[u]).deformData=null;var k,P=l[this._aniClipIndex],L=P.default;for(k in this._setDeform(L,w,this._boneSlotArray,i),P)"default"!=k&&k!=this._skinName&&(L=P[k],this._setDeform(L,w,this._boneSlotArray,i));L=P[this._skinName],this._setDeform(L,w,this._boneSlotArray,i)}if(this._drawOrder)for(u=0,d=this._drawOrder.length;u<d;u++)b=f[(s=this._boneSlotArray[this._drawOrder[u]]).name],C=M[s.name],isNaN(b)||-2==b||(this._templet.attachmentNames?s.showDisplayByName(this._templet.attachmentNames[b]):s.showDisplayByIndex(b)),w[this._drawOrder[u]]?(F=w[this._drawOrder[u]],s.currDisplayData&&F[s.currDisplayData.attachmentName]?s.deformData=F[s.currDisplayData.attachmentName]:s.deformData=null):s.deformData=null,isNaN(C)?s.draw(n,this._boneMatrixArray,2==this._aniMode):s.draw(n,this._boneMatrixArray,2==this._aniMode,C);else for(u=0,d=this._boneSlotArray.length;u<d;u++)b=f[(s=this._boneSlotArray[u]).name],C=M[s.name],isNaN(b)||-2==b||(this._templet.attachmentNames?s.showDisplayByName(this._templet.attachmentNames[b]):s.showDisplayByIndex(b)),w[u]?(F=w[u],s.currDisplayData&&F[s.currDisplayData.attachmentName]?s.deformData=F[s.currDisplayData.attachmentName]:s.deformData=null):s.deformData=null,isNaN(C)?s.draw(n,this._boneMatrixArray,2==this._aniMode):s.draw(n,this._boneMatrixArray,2==this._aniMode,C);return 0==this._aniMode?(this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,n),this._checkIsAllParsed(this._aniClipIndex)):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,n),n}_checkIsAllParsed(t){for(var e=Math.floor(.01+this._templet.getAniDuration(t)/1e3*this._player.cacheFrameRate),i=0;i<e;i++)if(!this._templet.getGrahicsDataWithCache(t,i))return;this._templet.getGrahicsDataWithCache(t,e)?this._templet.deleteAniData(t):this._createGraphics(e)}_setDeform(t,e,i,a){var s,r,n,h,l,o;if(t&&t)for(h=0,l=t.deformSlotDataList.length;h<l;h++)for(s=t.deformSlotDataList[h],o=0;o<s.deformSlotDisplayList.length;o++)n=i[(r=s.deformSlotDisplayList[o]).slotIndex],r.apply(a,n),e[r.slotIndex]||(e[r.slotIndex]={}),e[r.slotIndex][r.attachment]=r.deformData}getAnimNum(){return this._templet.getAnimationCount()}getAniNameByIndex(t){return this._templet.getAniNameByIndex(t)}getSlotByName(t){return this._boneSlotDic[t]}showSkinByName(t,e=!0){this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)}showSkinByIndex(t,e=!0){for(var i,a=0;a<this._boneSlotArray.length;a++)this._boneSlotArray[a].showSlotData(null,e);this._templet.showSkinByIndex(this._boneSlotDic,t,e)&&(i=this._templet.skinDataArray[t],this._skinIndex=t,this._skinName=i.name),this._clearCache()}showSlotSkinByIndex(t,e){0!=this._aniMode&&((t=this.getSlotByName(t))&&t.showDisplayByIndex(e),this._clearCache())}showSlotSkinByName(t,e){0!=this._aniMode&&((t=this.getSlotByName(t))&&t.showDisplayByName(e),this._clearCache())}replaceSlotSkinName(t,e,i){0!=this._aniMode&&((t=this.getSlotByName(t))&&t.replaceDisplayByName(e,i),this._clearCache())}replaceSlotSkinByIndex(t,e,i){0!=this._aniMode&&((t=this.getSlotByName(t))&&t.replaceDisplayByIndex(e,i),this._clearCache())}setSlotSkin(t,e){0!=this._aniMode&&((t=this.getSlotByName(t))&&t.replaceSkin(e),this._clearCache())}_clearCache(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;t<e;t++){for(var i=0,a=this._graphicsCache[t].length;i<a;i++){var s=this._graphicsCache[t][i];s&&s!=this.graphics&&U.recycle(s)}this._graphicsCache[t].length=0}}play(t,e,i=!0,a=0,s=0,r=!0,n=!0){this._playAudio=n,this._indexControl=!1;var h=-1,n=e?2147483647:0;if("string"==typeof t)for(var l=0,o=this._templet.getAnimationCount();l<o;l++){var u=this._templet.getAnimation(l);if(u&&t==u.name){h=l;break}}else h=t;-1<h&&h<this.getAnimNum()&&(this._aniClipIndex=h,(i||this._pause||this._currAniIndex!=h)&&(this._currAniIndex=h,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(h)),this._drawOrder=null,this._eventIndex=0,this._player.play(h,this._player.playbackRate,n,a,s),r&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=bt.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))}stop(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),0<this._soundChannelArr.length&&this._onAniSoundStoped(!0),this.timer.clear(this,this._update))}playbackRate(t){this._player&&(this._player.playbackRate=t)}paused(){if(!this._pause){if(this._pause=!0,this._player&&(this._player.paused=!0),0<this._soundChannelArr.length)for(var t,e=this._soundChannelArr.length,i=0;i<e;i++)(t=this._soundChannelArr[i]).isStopped||t.pause();this.timer.clear(this,this._update)}}resume(){if(this._indexControl=!1,this._pause){if(this._pause=!1,this._player&&(this._player.paused=!1),0<this._soundChannelArr.length)for(var t,e=this._soundChannelArr.length,i=0;i<e;i++)(t=this._soundChannelArr[i]).audioBuffer&&t.resume();this._lastTime=bt.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)}}_getGrahicsDataWithCache(t,e){return this._graphicsCache[t][e]}_setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}destroy(t=!0){super.destroy(t),this._templet._removeReference(1),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,this.timer.clear(this,this._update),0<this._soundChannelArr.length&&this._onAniSoundStoped(!0)}get index(){return this._index}set index(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,(this._aniClipIndex<0||this._aniClipIndex>=this.getAnimNum())&&(this._aniClipIndex=0,this._currAniIndex=0,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(this._currAniIndex)),this._drawOrder=null,this._eventIndex=0),this._update(!1))}get total(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}get player(){return this._player}get templet(){return this._templet}}r.useSimpleMeshInCanvas=!1,S.Skeleton=r,bt.ILaya.regClass(r),bt.ClassUtils.regClass("laya.ani.bone.Skeleton",r),bt.ClassUtils.regClass("Laya.Skeleton",r);class Nt{constructor(){this.slotArr=[]}}class Ot{createTexture(t){return this.texture||(this.texture=new bt.Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),this.texture)}destory(){this.texture&&this.texture.destroy()}}class Vt{constructor(){this.displayArr=[]}getDisplayByName(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1}}class Yt{constructor(){this.boneIndexs=[]}}class n extends f{constructor(){super(...arguments),this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this.skinSlotDisplayDataArr=[],this._isParseAudio=!1,this._isDestroyed=!1,this._rate=30,this.isParserComplete=!1,this.aniSectionDic={},this._textureDic={},this.mBoneArr=[]}loadAni(t){this._skBufferUrl=t,bt.ILaya.loader.load(t,bt.Handler.create(this,this.onComplete),null,bt.ILaya.Loader.BUFFER)}onComplete(t=0){var e;this._isDestroyed?this.destroy():(e=bt.ILaya.Loader.getRes(this._skBufferUrl))?(this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",this.parseData(null,e)):this.event(bt.Event.ERROR,"load failed:"+this._skBufferUrl)}parseData(t,e,i=30){var a,s;this._path||(a=this._relativeUrl||this.url)&&(s=a.lastIndexOf("/"),this._path=0<s?a.slice(0,s)+"/":""),this._mainTexture=t,this._rate=i,this.parse(e)}buildArmature(t=0){return new r(this,t)}parse(t){super.parse(t),this.event(bt.Event.LOADED,this),this._aniVersion===n.LAYA_ANIMATION_VISION?this._isParseAudio=!0:this._aniVersion!=n.LAYA_ANIMATION_160_VISION&&console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+n.LAYA_ANIMATION_VISION),this._mainTexture?this._parsePublicExtData():this._parseTexturePath()}_parseTexturePath(){if(this._isDestroyed)this.destroy();else{for(var t,e=0,i=(this._loadList=[],new bt.Byte(this.getPublicExtData())),a=i.getInt32(),s=i.readUTFString().split("\n"),e=0;e<a;e++)t=this._path+s[2*e],s[2*e+1],i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),i.getFloat32(),-1==this._loadList.indexOf(t)&&this._loadList.push(t);bt.ILaya.loader.load(this._loadList,bt.Handler.create(this,this._textureComplete))}}_textureComplete(){for(var t,e=0,i=this._loadList.length;e<i;e++)t=this._loadList[e],this._textureDic[t]=bt.ILaya.Loader.getRes(t);this._parsePublicExtData()}_parsePublicExtData(){for(var t=0,e=0,i=0,a=0,s=0,t=0,s=this.getAnimationCount();t<s;t++)this._graphicsCache.push([]);var E,r,n,R,N,O,V,h,l,Y="Dragon"!=this._aniClassName,o=new bt.Byte(this.getPublicExtData()),u=0,K=o.getInt32(),_=o.readUTFString(),X=_.split("\n");for(t=0;t<K;t++){if(h=this._mainTexture,l=this._path+X[2*t],_=X[2*t+1],!(h=null==this._mainTexture?this._textureDic[l]:h))return this.event(bt.Event.ERROR,this),void(this.isParseFail=!0);l=o.getFloat32(),E=o.getFloat32(),r=o.getFloat32(),n=o.getFloat32(),u=o.getFloat32(),R=isNaN(u)?0:u,u=o.getFloat32(),N=isNaN(u)?0:u,u=o.getFloat32(),O=isNaN(u)?r:u,u=o.getFloat32(),V=isNaN(u)?n:u,this.subTextureDic[_]=bt.Texture.create(h,l,E,r,n,-R,-N,O,V)}this._mainTexture=h;var p,d,c,m,W=o.getUint16();for(t=0;t<W;t++)(p=[]).push(o.getUint16()),p.push(o.getUint16()),p.push(o.getUint16()),p.push(o.getUint16()),this.aniSectionDic[t]=p;var x,y=o.getInt16(),z={};for(t=0;t<y;t++)d=new Ft,0==t?x=d:d.root=x,d.d=Y?-1:1,c=o.readUTFString(),m=o.readUTFString(),d.length=o.getFloat32(),1==o.getByte()&&(d.inheritRotation=!1),1==o.getByte()&&(d.inheritScale=!1),d.name=c,m&&((m=z[m])?m.addChild(d):this.mRootBone=d),z[c]=d,this.mBoneArr.push(d);this.tMatrixDataLen=o.getUint16();var g,f,G=o.getUint16(),q=Math.floor(G/this.tMatrixDataLen),H=this.srcBoneMatrixArr;for(t=0;t<q;t++)(g=new Ct).scX=o.getFloat32(),g.skX=o.getFloat32(),g.skY=o.getFloat32(),g.scY=o.getFloat32(),g.x=o.getFloat32(),g.y=o.getFloat32(),8===this.tMatrixDataLen&&(g.skewX=o.getFloat32(),g.skewY=o.getFloat32()),H.push(g),(d=this.mBoneArr[t]).transform=g;var Q,M,Z=o.getUint16();for(t=0;t<Z;t++){for(f=new Et,Q=o.getUint16(),e=0;e<Q;e++)f.boneNames.push(o.readUTFString()),f.boneIndexs.push(o.getInt16());f.name=o.readUTFString(),f.targetBoneName=o.readUTFString(),f.targetBoneIndex=o.getInt16(),f.bendDirection=o.getFloat32(),f.mix=o.getFloat32(),f.isSpine=Y,this.ikArr.push(f)}var j,D,J=o.getUint16();for(t=0;t<J;t++){for(M=new Yt,j=o.getUint16(),e=0;e<j;e++)M.boneIndexs.push(o.getInt16());M.name=o.getUTFString(),M.targetIndex=o.getInt16(),M.rotateMix=o.getFloat32(),M.translateMix=o.getFloat32(),M.scaleMix=o.getFloat32(),M.shearMix=o.getFloat32(),M.offsetRotation=o.getFloat32(),M.offsetX=o.getFloat32(),M.offsetY=o.getFloat32(),M.offsetScaleX=o.getFloat32(),M.offsetScaleY=o.getFloat32(),M.offsetShearY=o.getFloat32(),this.tfArr.push(M)}var $,tt,et,it,at,st,I,v,A,rt,nt=o.getUint16();for(t=0;t<nt;t++){for((D=new Rt).name=o.readUTFString(),$=o.getUint16(),e=0;e<$;e++)D.bones.push(o.getInt16());D.target=o.readUTFString(),D.positionMode=o.readUTFString(),D.spacingMode=o.readUTFString(),D.rotateMode=o.readUTFString(),D.offsetRotation=o.getFloat32(),D.position=o.getFloat32(),D.spacing=o.getFloat32(),D.rotateMix=o.getFloat32(),D.translateMix=o.getFloat32(),this.pathArr.push(D)}var T,ht=o.getInt16();for(t=0;t<ht;t++){var lt=o.getUint8(),ot={};this.deformAniArr.push(ot);for(var ut=0;ut<lt;ut++)for((I=new kt).skinName=o.getUTFString(),ot[I.skinName]=I,tt=o.getInt16(),e=0;e<tt;e++)for(v=new Pt,I.deformSlotDataList.push(v),et=o.getInt16(),i=0;i<et;i++)for(A=new Lt,v.deformSlotDisplayList.push(A),A.slotIndex=o.getInt16(),A.attachment=o.getUTFString(),it=o.getInt16(),a=0;a<it;a++)for(1==o.getByte()?A.tweenKeyList.push(!0):A.tweenKeyList.push(!1),at=o.getFloat32(),A.timeList.push(at),A.vectices.push(rt=[]),st=o.getInt16(),s=0;s<st;s++)rt.push(o.getFloat32())}var _t,S,pt,b,dt=o.getInt16();for(t=0;t<dt;t++){for(_t=o.getInt16(),T=[],e=0;e<_t;e++){for((S=new Ut).time=o.getFloat32(),pt=o.getInt16(),i=0;i<pt;i++)S.drawOrder.push(o.getInt16());T.push(S)}this.drawOrderAniArr.push(T)}var ct,C,mt=o.getInt16();for(t=0;t<mt;t++){for(ct=o.getInt16(),b=[],e=0;e<ct;e++)(C=new Bt).name=o.getUTFString(),this._isParseAudio&&(C.audioValue=o.getUTFString()),C.intValue=o.getInt32(),C.floatValue=o.getFloat32(),C.stringValue=o.getUTFString(),C.time=o.getFloat32(),b.push(C);this.eventAniArr.push(b)}var xt=o.getInt16();if(0<xt)for(this.attachmentNames=[],t=0;t<xt;t++)this.attachmentNames.push(o.getUTFString());var F,w,yt=o.getInt16();for(t=0;t<yt;t++)(F=new wt).name=o.readUTFString(),F.parent=o.readUTFString(),F.attachmentName=o.readUTFString(),F.srcDisplayIndex=F.displayIndex=o.getInt16(),(F.templet=this).boneSlotDic[F.name]=F,null==(w=this.bindBoneBoneSlotDic[F.parent])&&(this.bindBoneBoneSlotDic[F.parent]=w=[]),w.push(F),this.boneSlotArray.push(F);var k,P,L,gt,ft,Mt,Dt,It,vt,At,U=o.readUTFString().split("\n"),B=0,Tt=o.getUint8();for(t=0;t<Tt;t++){for((k=new Nt).name=U[B++],gt=o.getUint8(),e=0;e<gt;e++){for((P=new Vt).name=U[B++],F=this.boneSlotDic[P.name],ft=o.getUint8(),i=0;i<ft;i++){if(L=new Ot,this.skinSlotDisplayDataArr.push(L),L.name=U[B++],L.attachmentName=U[B++],L.transform=new Ct,L.transform.scX=o.getFloat32(),L.transform.skX=o.getFloat32(),L.transform.skY=o.getFloat32(),L.transform.scY=o.getFloat32(),L.transform.x=o.getFloat32(),L.transform.y=o.getFloat32(),P.displayArr.push(L),L.width=o.getFloat32(),L.height=o.getFloat32(),L.type=o.getUint8(),L.verLen=o.getUint16(),0<(y=o.getUint16()))for(L.bones=[],a=0;a<y;a++){var St=o.getUint16();L.bones.push(St)}if(0<(Mt=o.getUint16()))for(L.uvs=[],a=0;a<Mt;a++)L.uvs.push(o.getFloat32());if(0<(Dt=o.getUint16()))for(L.weights=[],a=0;a<Dt;a++)L.weights.push(o.getFloat32());if(0<(It=o.getUint16()))for(L.triangles=[],a=0;a<It;a++)L.triangles.push(o.getUint16());if(0<(vt=o.getUint16()))for(L.vertices=[],a=0;a<vt;a++)L.vertices.push(o.getFloat32());if(0<(At=o.getUint16()))for(L.lengths=[],a=0;a<At;a++)L.lengths.push(o.getFloat32())}k.slotArr.push(P)}this.skinDic[k.name]=k,this.skinDataArray.push(k)}1==o.getUint8()?(this.yReverseMatrix=new bt.Matrix(1,0,0,-1,0,0),x&&x.setTempMatrix(this.yReverseMatrix)):x&&x.setTempMatrix(new bt.Matrix),this.showSkinByIndex(this.boneSlotDic,2),this.isParserComplete=!0,this.event(bt.Event.COMPLETE,this)}getTexture(t){var e=this.subTextureDic[t];return null==(e=e||this.subTextureDic[t.substr(0,t.length-1)])?this._mainTexture:e}showSkinByIndex(t,e,i=!0){if(e<0&&e>=this.skinDataArray.length)return!1;var a,s,r,n,h=this.skinDataArray[e];if(h){for(a=0,s=h.slotArr.length;a<s;a++)(n=h.slotArr[a])&&(r=t[n.name])&&(r.showSlotData(n,i),i&&"undefined"!=r.attachmentName&&"null"!=r.attachmentName?r.showDisplayByName(r.attachmentName):r.showDisplayByIndex(r.displayIndex));return!0}return!1}getSkinIndexByName(t){for(var e=0,i=this.skinDataArray.length;e<i;e++)if(this.skinDataArray[e].name==t)return e;return-1}getGrahicsDataWithCache(t,e){return this._graphicsCache[t]&&this._graphicsCache[t][e]?this._graphicsCache[t][e]:null}_setCreateURL(t){this._skBufferUrl=this._relativeUrl=t,super._setCreateURL(t)}setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}deleteAniData(t){this._anis[t]&&((t=this._anis[t]).bone3DMap=null,t.nodes=null)}destroy(){for(var t in this._isDestroyed=!0,this.subTextureDic)t&&this.subTextureDic[t].destroy();for(t in this._textureDic)t&&this._textureDic[t].destroy();for(var e=0,i=this.skinSlotDisplayDataArr.length;e<i;e++)this.skinSlotDisplayDataArr[e].destory();this.skinSlotDisplayDataArr.length=0,this._relativeUrl&&delete n.TEMPLET_DICTIONARY[this._relativeUrl],super.destroy(),bt.ILaya.loader.clearRes(this._skBufferUrl)}getAniNameByIndex(t){t=this.getAnimation(t);return t?t.name:null}get rate(){return this._rate}set rate(t){this._rate=t}}n.LAYA_ANIMATION_160_VISION="LAYAANIMATION:1.6.0",n.LAYA_ANIMATION_VISION="LAYAANIMATION:1.7.0",S.Templet=n;class p extends bt.Sprite{constructor(t=null){super(),this._start=0,this._Pos=0,this._ended=!0,this._loadedImage={},this._endFrame=-1,this.interval=30,this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,(this._parentMovieClip=t)?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setBitUp(bt.Const.DISPLAY))}destroy(t=!0){this._clear(),super.destroy(t)}_setDisplay(t){super._setDisplay(t),this._isRoot&&this._onDisplay(t)}_onDisplay(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)}updates(){if(!this._parentMovieClip)for(var t=this._movieClipList.length,e=0;e<t;e++)this._movieClipList[e]&&this._movieClipList[e]._update()}get index(){return this._playIndex}set index(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event(bt.Event.LABEL,this._labels[t])}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]=t}removeLabel(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null}get count(){return this._count}get playing(){return this._playing}_update(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}var t;this._parseFrame(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event(bt.Event.LABEL,this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex&&(this._endFrame=-1,null!=this._completeHandler&&(t=this._completeHandler,this._completeHandler=null,t.run()),this.stop())}}stop(){this._playing=!1}gotoAndStop(t){this.index=t,this.stop()}_clear(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){var t,e;for(this.timer.clear(this,this.updates),e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}for(var i in this._atlasPath&&bt.ILaya.Loader.clearRes(this._atlasPath),this._loadedImage)this._loadedImage[i]&&(bt.ILaya.Loader.clearRes(i),this._loadedImage[i]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null}play(t=0,e=!0){this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)}_displayFrame(t=-1){-1!=t&&(this._curIndex>t&&this._reset(),this._parseFrame(t))}_reset(t=!0){t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start}_parseFrame(t){var e,i=!1,a=this._idOfSprite,s=this._data;for(this._ended&&this._reset(),s.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),s.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(s.getUint16()){case 12:var r,n,h=s.getUint16(),l=this._ids[s.getUint16()];this._Pos=s.pos,s.pos=l,0==(e=s.getUint8())?(u=s.getUint16(),(r=a[h])||(r=a[h]=new bt.Sprite,(n=new bt.Sprite).loadImage(this.basePath+u+".png"),this._loadedImage[this.basePath+u+".png"]=!0,r.addChild(n),n.size(s.getFloat32(),s.getFloat32()),u=s._getMatrix(),n.transform=u),r.alpha=1):1==e&&((n=a[h])||(a[h]=n=new p(this),n.interval=this.interval,n._ids=this._ids,n.basePath=this.basePath,n._setData(s,l),n._initState(),n.play(0)),n.alpha=1),s.pos=this._Pos;break;case 3:var o=a[s.getUint16()];o&&(this.addChild(o),o.zOrder=s.getUint16(),i=!0);break;case 4:(o=a[s.getUint16()])&&o.removeSelf();break;case 5:a[s.getUint16()][p._ValueList[s.getUint16()]]=s.getFloat32();break;case 6:a[s.getUint16()].visible=0<s.getUint8();break;case 7:var u=(r=a[s.getUint16()]).transform||bt.Matrix.create();u.setTo(s.getFloat32(),s.getFloat32(),s.getFloat32(),s.getFloat32(),s.getFloat32(),s.getFloat32()),r.transform=u;break;case 8:a[s.getUint16()].setPos(s.getFloat32(),s.getFloat32());break;case 9:a[s.getUint16()].setSize(s.getFloat32(),s.getFloat32());break;case 10:a[s.getUint16()].alpha=s.getFloat32();break;case 11:a[s.getUint16()].setScale(s.getFloat32(),s.getFloat32());break;case 98:e=s.getString(),this.event(e),"stop"==e&&this.stop();break;case 99:this._curIndex=s.getUint16(),i&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event(bt.Event.FRAME),this.event(bt.Event.END),this.event(bt.Event.COMPLETE)),this._reset(!1)}this._playing&&!this._ended&&this.event(bt.Event.FRAME),this._Pos=s.pos}_setData(t,e){this._data=t,this._start=e+3}set url(t){this.load(t)}load(t,e=!1,i=null){this._url=t,e&&(this._atlasPath=i||t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this],e=[{url:t,type:bt.ILaya.Loader.BUFFER}],this._atlasPath&&e.push({url:this._atlasPath,type:bt.ILaya.Loader.ATLAS}),bt.ILaya.loader.load(e,bt.Handler.create(this,this._onLoaded))}_onLoaded(){var t=bt.ILaya.Loader.getRes(this._url);t?this._atlasPath&&!bt.ILaya.Loader.getAtlas(this._atlasPath)?this.event(bt.Event.ERROR,"Atlas not find"):(this.basePath=this._atlasPath?bt.ILaya.Loader.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",this._initData(t)):this.event(bt.Event.ERROR,"file not find")}_initState(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parseFrame(++this._curIndex);this._playing=t}_initData(t){this._data=new bt.Byte(t);for(var e=this._data.getUint16(),i=0;i<e;i++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event(bt.Event.LOADED),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)}playTo(t,e,i=null){this._completeHandler=i,this._endFrame=e,this.play(t,!1)}}p._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],t.AnimationContent=b,t.AnimationNodeContent=C,t.AnimationParser01=i,t.AnimationParser02=g,t.AnimationPlayer=h,t.AnimationState=e,t.AnimationTemplet=f,t.BezierLerp=_,t.Bone=Ft,t.BoneSlot=wt,t.DeformAniData=kt,t.DeformSlotData=Pt,t.DeformSlotDisplayData=Lt,t.DrawOrderData=Ut,t.EventData=Bt,t.GraphicsAni=U,t.IAniLib=S,t.IkConstraint=k,t.IkConstraintData=Et,t.KeyFramesContent=F,t.MeshData=a,t.MovieClip=p,t.PathConstraint=P,t.PathConstraintData=Rt,t.Skeleton=r,t.SkinData=Nt,t.SkinMeshForGraphic=s,t.SkinSlotDisplayData=Ot,t.SlotData=Vt,t.Templet=n,t.TfConstraint=l,t.TfConstraintData=Yt,t.Transform=Ct,t.UVTools=M}(window.Laya=window.Laya||{},Laya);